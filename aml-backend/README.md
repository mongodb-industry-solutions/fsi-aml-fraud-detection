# ThreatSight 360 - AML/KYC Backend

![MongoDB](https://img.shields.io/badge/MongoDB-%234ea94b.svg?style=for-the-badge&logo=mongodb&logoColor=white)
![FastAPI](https://img.shields.io/badge/FastAPI-005571?style=for-the-badge&logo=fastapi)
![Python](https://img.shields.io/badge/python-3670A0?style=for-the-badge&logo=python&logoColor=ffdd54)
![AWS](https://img.shields.io/badge/AWS-%23FF9900.svg?style=for-the-badge&logo=amazon-aws&logoColor=white)

**Advanced Anti-Money Laundering (AML) and Know Your Customer (KYC) Backend Service**

In today's complex regulatory environment, financial institutions must maintain robust AML/KYC systems for compliance and risk management. This backend service provides comprehensive entity management, intelligent resolution, and relationship analysis capabilities designed specifically for financial services compliance operations.

The AML/KYC backend leverages MongoDB Atlas Search, AWS Bedrock AI services, and advanced graph analytics to deliver real-time entity resolution, fuzzy matching, and network analysis capabilities that scale with your compliance operations.

## Key Features

- **üîç Intelligent Entity Resolution**: AI-powered fuzzy matching and duplicate detection using MongoDB Atlas Search
- **üåê Network Analysis**: Relationship mapping and connected component analysis for compliance investigations
- **‚ö° Real-time Search**: Multi-strategy search with Atlas Search, Vector Search, and Unified Search
- **üéØ Risk Assessment**: Comprehensive entity risk scoring and watchlist matching
- **üîó Relationship Management**: Entity relationship tracking with audit trails
- **üìä Advanced Analytics**: Performance metrics and search analytics
- **üèóÔ∏è Clean Architecture**: Repository pattern with dependency injection and comprehensive testing

## Architecture Overview

The AML backend follows a **clean architecture pattern** with three-layer organization:

### **Models Layer** (Consolidated Architecture)

- **`models/core/`**: Domain models (Entity, Resolution, Network)
- **`models/api/`**: Request/Response models for API boundaries
- **`models/database/`**: Database collection configurations
- **`models/legacy_compatibility.py`**: Migration support with deprecation warnings

### **Repository Layer** (Data Access Abstraction)

- **Interface-driven**: Abstract interfaces in `repositories/interfaces/`
- **Factory Pattern**: Centralized repository creation in `repositories/factory/`
- **Dual MongoDB Support**: Both sync (PyMongo) and async (Motor) drivers
- **Singleton Pattern**: Shared connection pooling

### **Service Layer** (Business Logic)

- **Core Services**: Entity resolution, matching, confidence scoring
- **Search Services**: Atlas Search, Vector Search, Unified Search
- **Network Services**: Graph analysis and relationship mapping
- **Dependencies**: Clean FastAPI dependency injection

### **Route Organization** (API Layer)

- **Core Routes**: `/routes/core/` - Entity CRUD and resolution workflows
- **Search Routes**: `/routes/search/` - Multiple search strategies
- **Network Routes**: `/routes/network/` - Graph analysis
- **Debug Routes**: `/routes/debug/` - Development tools

## Prerequisites

Before you begin, ensure you have the following:

- **Python 3.10+**: Required for the backend service
- **Poetry**: For dependency management and virtual environments
- **MongoDB Atlas Account**: For data storage and Atlas Search capabilities
- **AWS Account with Bedrock Access**: For AI-powered entity resolution features
- **Docker (Optional)**: For containerized deployment

## Quick Start

### 1. Installation

Navigate to the AML backend directory and install dependencies:

```bash
cd aml-backend
poetry install
```

### 2. Environment Configuration

Create a `.env` file in the `aml-backend` directory:

```bash
# MongoDB Connection
MONGODB_URI=mongodb+srv://<username>:<password>@cluster.mongodb.net/
DB_NAME=threatsight360

# AWS Bedrock Credentials (for AI features)
AWS_ACCESS_KEY_ID=your_aws_access_key_here
AWS_SECRET_ACCESS_KEY=your_aws_secret_key_here
AWS_REGION=us-east-1

# Server Configuration
HOST=0.0.0.0
PORT=8001

# Frontend URL for CORS
FRONTEND_URL=http://localhost:3000

# Atlas Search Configuration
ATLAS_SEARCH_INDEX=entity_search_index_v2
ENTITY_VECTOR_INDEX=entity_vector_search_index
```

### 3. MongoDB Atlas Search Setup

The AML backend requires MongoDB Atlas Search indexes for optimal performance:

#### Entity Resolution Search Index

Create an Atlas Search index named `entity_resolution_search`:

```json
{
  "mappings": {
    "dynamic": false,
    "fields": {
      "name": {
        "type": "document",
        "fields": {
          "full": [
            {
              "type": "string",
              "analyzer": "lucene.standard"
            },
            {
              "type": "autocomplete",
              "tokenization": "edgeGram",
              "minGrams": 2,
              "maxGrams": 15,
              "foldDiacritics": true
            }
          ],
          "aliases": {
            "type": "string",
            "analyzer": "lucene.standard"
          }
        }
      },
      "entityType": {
        "type": "stringFacet"
      },
      "nationality": {
        "type": "stringFacet"
      },
      "residency": {
        "type": "stringFacet"
      },
      "jurisdictionOfIncorporation": {
        "type": "stringFacet"
      },
      "riskAssessment": {
        "type": "document",
        "fields": {
          "overall": {
            "type": "document",
            "fields": {
              "level": {
                "type": "stringFacet"
              },
              "score": {
                "type": "numberFacet",
                "boundaries": [0.0, 15.0, 25.0, 50.0, 100.0]
              }
            }
          }
        }
      },
      "customerInfo": {
        "type": "document",
        "fields": {
          "businessType": {
            "type": "stringFacet"
          }
        }
      },
      "addresses": {
        "type": "document",
        "fields": {
          "structured": {
            "type": "document",
            "fields": {
              "country": {
                "type": "string",
                "analyzer": "lucene.keyword"
              },
              "city": {
                "type": "string",
                "analyzer": "lucene.keyword"
              }
            }
          },
          "full": {
            "type": "string",
            "analyzer": "lucene.standard"
          }
        }
      },
      "identifiers": {
        "type": "document",
        "fields": {
          "type": {
            "type": "string",
            "analyzer": "lucene.keyword"
          },
          "value": {
            "type": "string",
            "analyzer": "lucene.standard"
          }
        }
      },
      "scenarioKey": {
        "type": "string",
        "analyzer": "lucene.keyword"
      }
    }
  }
}
```

#### Vector Search Index (Optional)

For semantic similarity search, create a vector search index named `entity_vector_search_index`:

```json
{
  "type": "vectorSearch",
  "fields": [
    {
      "type": "vector",
      "path": "embedding",
      "numDimensions": 1536,
      "similarity": "cosine"
    }
  ]
}
```

### 4. Start the Server

Launch the AML backend server:

```bash
# Development mode with auto-reload
poetry run uvicorn main:app --host 0.0.0.0 --port 8001 --reload

# Production mode
poetry run uvicorn main:app --host 0.0.0.0 --port 8001
```

The API will be available at [http://localhost:8001](http://localhost:8001)

> [!Note]
> For comprehensive entity data generation, use the [Entity Resolution Synthetic Data Generation notebook](../docs/ThreatSight%20360%20-%20Entity%20Resolution%20Synthetic%20Data%20Generation.ipynb) in [Google Colab](https://colab.research.google.com/) to populate your database with realistic AML/KYC test data including entities, relationships, and risk profiles.

## API Endpoints

### üè† System Endpoints

| Endpoint  | Method | Description                             |
| --------- | ------ | --------------------------------------- |
| `/`       | GET    | Service status and feature overview     |
| `/health` | GET    | Health check with database connectivity |
| `/test`   | GET    | Simple connectivity test                |
| `/docs`   | GET    | Interactive API documentation (Swagger) |

### üë• Core Entity Management

| Endpoint                            | Method | Description                                         |
| ----------------------------------- | ------ | --------------------------------------------------- |
| `/entities/`                        | GET    | List entities with pagination and filtering         |
| `/entities/{entity_id}`             | GET    | Get detailed entity information                     |
| `/entities/onboarding/find_matches` | POST   | Find potential duplicate entities during onboarding |
| `/entities/resolve`                 | POST   | Merge entities after resolution                     |

### üîç Search Operations

| Endpoint                        | Method | Description                          |
| ------------------------------- | ------ | ------------------------------------ |
| `/entities/search/unified`      | GET    | Unified multi-strategy entity search |
| `/entities/search/autocomplete` | GET    | Real-time autocomplete suggestions   |
| `/entities/search/facets`       | GET    | Available facet filters with counts  |
| `/search/atlas/{query}`         | GET    | Atlas Search with fuzzy matching     |
| `/search/vector/{query}`        | GET    | Vector similarity search             |
| `/search/unified/{query}`       | GET    | Combined Atlas and Vector search     |

### üåê Network Analysis

| Endpoint                                         | Method | Description                    |
| ------------------------------------------------ | ------ | ------------------------------ |
| `/network/{entity_id}`                           | GET    | Entity relationship network    |
| `/network/{entity_id}/connected`                 | GET    | Connected component analysis   |
| `/network/{entity_id}/shortest_path/{target_id}` | GET    | Shortest path between entities |

### üîó Relationship Management

| Endpoint                           | Method | Description               |
| ---------------------------------- | ------ | ------------------------- |
| `/relationships/`                  | GET    | List entity relationships |
| `/relationships/`                  | POST   | Create new relationship   |
| `/relationships/{relationship_id}` | GET    | Get relationship details  |
| `/relationships/{relationship_id}` | PUT    | Update relationship       |
| `/relationships/{relationship_id}` | DELETE | Delete relationship       |

## Data Models

### Core Entity Model

```json
{
  "entityId": "ENT_12345",
  "entityType": "INDIVIDUAL",
  "name": {
    "full": "John Smith",
    "structured": {
      "first": "John",
      "middle": "",
      "last": "Smith"
    },
    "aliases": ["Johnny Smith", "J. Smith"]
  },
  "dateOfBirth": "1985-03-15T00:00:00Z",
  "addresses": [
    {
      "structured": {
        "street": "123 Main St",
        "city": "New York",
        "state": "NY",
        "country": "US",
        "postalCode": "10001"
      },
      "full": "123 Main St, New York, NY 10001, US",
      "type": "RESIDENTIAL"
    }
  ],
  "identifiers": [
    {
      "type": "SSN",
      "value": "123-45-6789",
      "country": "US"
    }
  ],
  "riskAssessment": {
    "overall": {
      "score": 25.5,
      "level": "MEDIUM"
    },
    "factors": {
      "pep": false,
      "sanctions": false,
      "adverseMedia": false
    }
  },
  "watchlistMatches": [],
  "created_at": "2024-01-01T00:00:00Z",
  "updated_at": "2024-01-15T10:30:00Z"
}
```

### Entity Resolution Response

```json
{
  "success": true,
  "matches": [
    {
      "entityId": "ENT_67890",
      "confidence": 0.85,
      "reasons": [
        "Exact name match",
        "Partial address match",
        "Identifier similarity"
      ],
      "entityData": { ... }
    }
  ],
  "totalMatches": 1,
  "searchMetadata": {
    "searchType": "atlas_entity_search",
    "processingTimeMs": 45,
    "confidenceThreshold": 0.7
  }
}
```

### Network Analysis Response

```json
{
  "success": true,
  "data": {
    "nodes": [
      {
        "id": "ENT_12345",
        "type": "INDIVIDUAL",
        "name": "John Smith",
        "riskLevel": "MEDIUM"
      }
    ],
    "edges": [
      {
        "source": "ENT_12345",
        "target": "ENT_67890",
        "relationship": "FAMILY_MEMBER",
        "strength": 0.8
      }
    ],
    "statistics": {
      "totalNodes": 15,
      "totalEdges": 23,
      "connectedComponents": 3,
      "maxDepth": 4
    }
  }
}
```

### Entity Resolution

```bash
# Find potential matches for new entity
curl -X POST "http://localhost:8001/entities/onboarding/find_matches" \
  -H "Content-Type: application/json" \
  -d '{
    "entity_name": "John Smith",
    "entity_type": "INDIVIDUAL",
    "address": "123 Main St, New York, NY",
    "fuzzy_matching": true,
    "limit": 10
  }'
```

### Network Analysis

```bash
# Get entity network
curl "http://localhost:8001/network/ENT_12345?depth=2"

# Find connected entities
curl "http://localhost:8001/network/ENT_12345/connected"

# Shortest path between entities
curl "http://localhost:8001/network/ENT_12345/shortest_path/ENT_67890"
```

## Project Structure

```
aml-backend/
‚îú‚îÄ‚îÄ main.py                          # FastAPI application entry point
‚îú‚îÄ‚îÄ dependencies.py                  # FastAPI dependencies and configuration
‚îú‚îÄ‚îÄ pyproject.toml                   # Poetry dependencies and project config
‚îú‚îÄ‚îÄ .env.example                     # Environment variables template
‚îú‚îÄ‚îÄ README.md                        # This file
‚îú‚îÄ‚îÄ ARCHITECTURE_ANALYSIS.md         # Architecture documentation
‚îÇ
‚îú‚îÄ‚îÄ models/                          # Consolidated data models
‚îÇ   ‚îú‚îÄ‚îÄ core/                       # Domain models
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ entity.py               # Entity models and validation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ resolution.py           # Resolution result models
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ network.py              # Network analysis models
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ relationship.py         # Relationship models
‚îÇ   ‚îú‚îÄ‚îÄ api/                        # Request/Response models
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ requests.py             # API request models
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ responses.py            # API response models
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ entity_list.py          # Entity listing models
‚îÇ   ‚îú‚îÄ‚îÄ database/                   # Database configuration
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ collections.py          # Collection schemas
‚îÇ   ‚îî‚îÄ‚îÄ legacy_compatibility.py     # Migration support
‚îÇ
‚îú‚îÄ‚îÄ repositories/                    # Data access layer
‚îÇ   ‚îú‚îÄ‚îÄ interfaces/                 # Abstract repository interfaces
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ entity_repository.py    # Entity data access interface
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ relationship_repository.py # Relationship interface
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ vector_search_repository.py # Vector search interface
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ network_repository.py   # Network analysis interface
‚îÇ   ‚îú‚îÄ‚îÄ impl/                       # Repository implementations
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ entity_repository.py    # MongoDB entity implementation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ atlas_search_repository.py # Atlas Search implementation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ vector_search_repository.py # Vector search implementation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ relationship_repository.py # Relationship implementation
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ network_repository.py   # Network analysis implementation
‚îÇ   ‚îî‚îÄ‚îÄ factory/                    # Repository factory pattern
‚îÇ       ‚îî‚îÄ‚îÄ repository_factory.py   # Centralized repository creation
‚îÇ
‚îú‚îÄ‚îÄ services/                       # Business logic layer
‚îÇ   ‚îú‚îÄ‚îÄ core/                       # Core business services
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ entity_resolution_service.py # Entity resolution logic
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ matching_service.py     # Matching algorithms
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ confidence_service.py   # Confidence scoring
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ merge_service.py        # Entity merging logic
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ relationship_service.py # Relationship management
‚îÇ   ‚îú‚îÄ‚îÄ search/                     # Search services
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ entity_search_service.py # Unified entity search
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ atlas_search_service.py # Atlas Search operations
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ vector_search_service.py # Vector similarity search
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ unified_search_service.py # Combined search strategies
‚îÇ   ‚îú‚îÄ‚îÄ network/                    # Network analysis services
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ network_analysis_service.py # Graph analysis
‚îÇ   ‚îî‚îÄ‚îÄ dependencies.py             # Service dependency injection
‚îÇ
‚îú‚îÄ‚îÄ routes/                         # API endpoints
‚îÇ   ‚îú‚îÄ‚îÄ core/                       # Core entity operations
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ entities.py             # Entity CRUD endpoints
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ entity_resolution.py    # Resolution endpoints
‚îÇ   ‚îú‚îÄ‚îÄ search/                     # Search endpoints
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ entity_search.py        # Unified entity search
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ atlas_search.py         # Atlas Search endpoints
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ vector_search.py        # Vector search endpoints
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ unified_search.py       # Combined search endpoints
‚îÇ   ‚îú‚îÄ‚îÄ network/                    # Network analysis endpoints
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ network_analysis.py     # Graph analysis endpoints
‚îÇ   ‚îú‚îÄ‚îÄ debug/                      # Development and debug endpoints
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ search_debug.py         # Search debugging tools
‚îÇ   ‚îî‚îÄ‚îÄ relationships_updated.py    # Relationship management
‚îÇ
‚îú‚îÄ‚îÄ reference/                      # Reference implementations
‚îÇ   ‚îú‚îÄ‚îÄ mongodb_core_lib.py         # Core MongoDB utilities
‚îÇ   ‚îî‚îÄ‚îÄ entity_resolution_implementation.md # Implementation guide
‚îÇ
‚îú‚îÄ‚îÄ bedrock/                        # AWS Bedrock integration
‚îÇ   ‚îú‚îÄ‚îÄ client.py                   # Bedrock client setup
‚îÇ   ‚îî‚îÄ‚îÄ embeddings.py               # Embedding generation
‚îÇ
‚îú‚îÄ‚îÄ utils/                          # Utility modules
‚îÇ   ‚îî‚îÄ‚îÄ atlas_search_builder.py     # Atlas Search query builder
‚îÇ
‚îî‚îÄ‚îÄ db/                             # Database utilities
    ‚îî‚îÄ‚îÄ mongo_db.py                 # MongoDB connection management
```

## Performance Optimization

### MongoDB Indexes

Ensure the following indexes are created for optimal performance:

```javascript
// Entity indexes
db.entities.createIndex({ entityId: 1 });
db.entities.createIndex({ 'name.full': 'text' });
db.entities.createIndex({
  entityType: 1,
  'riskAssessment.overall.level': 1,
});
db.entities.createIndex({
  'identifiers.value': 1,
  'identifiers.type': 1,
});

// Relationship indexes
db.entity_relationships.createIndex({ source_entity_id: 1 });
db.entity_relationships.createIndex({ target_entity_id: 1 });
db.entity_relationships.createIndex({ relationship_type: 1 });
```

## Deployment

### Docker Deployment

Create a `Dockerfile.aml-backend`:

```dockerfile
FROM python:3.10-slim-buster

ENV GET_POETRY_IGNORE_DEPRECATION=1

WORKDIR /

# Poetry dependencies
COPY aml-backend/pyproject.toml aml-backend/poetry.lock ./

# Poetry installation
RUN pip install poetry==1.8.4

# Poetry config & install dependencies
RUN poetry config virtualenvs.create true
RUN poetry config virtualenvs.in-project true
RUN rm -rf .venv  # Remove any copied local venv
RUN poetry lock --no-update
RUN poetry install --no-interaction -v --no-cache --no-root

COPY ./aml-backend/ .

EXPOSE 8001

CMD ["poetry", "run", "uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8001"]
```

## Additional Resources

- [MongoDB Atlas Search Documentation](https://www.mongodb.com/docs/atlas/atlas-search/)
- [AWS Bedrock Documentation](https://docs.aws.amazon.com/bedrock/)
- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [Poetry Documentation](https://python-poetry.org/docs/)
- [Pydantic Documentation](https://docs.pydantic.dev/)

## License

This project is licensed under the MIT License - see the [LICENSE](../LICENSE) file for details.
